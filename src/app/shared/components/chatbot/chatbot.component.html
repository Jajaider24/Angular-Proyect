<!-- 
  Chatbot Flotante
  Componente flotante en la esquina inferior derecha con:
  - BotÃ³n circular para abrir/cerrar
  - Chat box con avatar, historial y campo de entrada
  - Controles: cerrar, refresh, enviar
-->
<div class="chat-container">
  <!-- BotÃ³n flotante para abrir el chat -->
  <button
    *ngIf="!isOpen"
    class="open-button"
    (click)="toggleChat()"
    title="Abrir asistente virtual"
  >
    ğŸ’¬
  </button>

  <!-- Chat Box -->
  <div *ngIf="isOpen" class="chat-box">
    <!-- Header con tÃ­tulo y botones de control -->
    <div id="chat-title">
      <strong>Asistente Virtual</strong>

      <!-- BotÃ³n silenciar/activar voz -->
      <button
        class="voice-button"
        (click)="toggleVoice()"
        [title]="isSpeaking ? 'Silenciar' : 'Voz activa'"
      >
        {{ isSpeaking ? "ğŸ”‡" : "ğŸ”Š" }}
      </button>

      <!-- BotÃ³n refresh -->
      <button
        class="refresh-button"
        (click)="refreshChat()"
        title="Reiniciar conversaciÃ³n"
      >
        ğŸ”„
      </button>

      <!-- BotÃ³n cerrar -->
      <button class="close-button" (click)="toggleChat()" title="Cerrar chat">
        âœ•
      </button>
    </div>

    <!-- Avatar animado con Lottie -->
    <div class="avatar-container">
      <ng-lottie
        [options]="avatarOptions"
        [styles]="{ width: '120px', height: '120px' }"
        [class.speaking]="isSpeaking || loading"
      ></ng-lottie>
    </div>

    <!-- Mensaje descriptivo -->
    <div id="chat-message">
      <small>PregÃºntame sobre el sistema de delivery ğŸ”ğŸï¸</small>
    </div>

    <!-- Historial de conversaciÃ³n -->
    <div class="chat-history-box">
      <div
        *ngFor="let msg of chatHistory"
        class="message"
        [class.user-message]="msg.role === 'user'"
        [class.bot-message]="msg.role === 'bot'"
      >
        <div class="message-bubble">
          <strong *ngIf="msg.role === 'user'">TÃº:</strong>
          <strong *ngIf="msg.role === 'bot'">ğŸ¤– Bot:</strong>
          <p>{{ msg.content }}</p>
          <span class="message-time">
            {{ msg.timestamp | date : "short" }}
          </span>
        </div>
      </div>

      <!-- Indicador de carga mientras espera respuesta -->
      <div *ngIf="loading" class="message bot-message">
        <div class="message-bubble loading-bubble">
          <strong>ğŸ¤– Bot:</strong>
          <p>
            <span class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </span>
            Escribiendo...
          </p>
        </div>
      </div>
    </div>

    <!-- Campo de entrada y botÃ³n enviar -->
    <div class="input-area">
      <input
        id="chat-input"
        type="text"
        [(ngModel)]="userInput"
        (keypress)="onKeyPress($event)"
        placeholder="Escribe tu pregunta..."
        [disabled]="loading"
      />
      <button
        id="send-message"
        (click)="sendMessage()"
        [disabled]="loading || !userInput.trim()"
        title="Enviar mensaje"
      >
        ğŸ“¤
      </button>
    </div>
  </div>
</div>
